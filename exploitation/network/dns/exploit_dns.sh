#!/bin/bash
# Script de Exploração DNS - Autônomo e Brutal

# Solicitar target do usuário
if [ -z "$1" ]; then
    echo "Uso: $0 <DOMINIO>"
    echo "Exemplo: $0 exemplo.com.br"
    exit 1
fi

TARGET="$1"
LOG_DIR="./logs"
RESULTS_DIR="./results"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}[*] Iniciando exploração DNS contra ${TARGET}${NC}"

mkdir -p $LOG_DIR $RESULTS_DIR

# Verificar e instalar ferramentas
check_and_install() {
    if ! command -v $1 &> /dev/null; then
        echo -e "${YELLOW}[!] $1 não encontrado. Instalando...${NC}"
        sudo apt-get update -qq
        sudo apt-get install -y $2
    fi
}

echo -e "${GREEN}[*] Verificando ferramentas...${NC}"
check_and_install "nmap" "nmap"
check_and_install "dnsenum" "dnsenum"
check_and_install "dnsrecon" "dnsrecon"
check_and_install "fierce" "fierce"
check_and_install "dig" "dnsutils"
check_and_install "host" "bind9-host"
check_and_install "msfconsole" "metasploit-framework"

# 1. ENUMERAÇÃO DNS BÁSICA
echo -e "${GREEN}[*] Fase 1: Enumeração DNS Básica${NC}"

# Dig - múltiplas queries
echo -e "${YELLOW}[*] Executando dig...${NC}"
dig $TARGET ANY +noall +answer > $LOG_DIR/dig_any.txt 2>&1
dig $TARGET MX +noall +answer > $LOG_DIR/dig_mx.txt 2>&1
dig $TARGET NS +noall +answer > $LOG_DIR/dig_ns.txt 2>&1
dig $TARGET TXT +noall +answer > $LOG_DIR/dig_txt.txt 2>&1
dig $TARGET SOA +noall +answer > $LOG_DIR/dig_soa.txt 2>&1

# Host
echo -e "${YELLOW}[*] Executando host...${NC}"
host -a $TARGET > $LOG_DIR/host_all.txt 2>&1
host -t MX $TARGET > $LOG_DIR/host_mx.txt 2>&1
host -t NS $TARGET > $LOG_DIR/host_ns.txt 2>&1
host -t TXT $TARGET > $LOG_DIR/host_txt.txt 2>&1

# 2. ENUMERAÇÃO AGRESSIVA DE SUBDOMÍNIOS
echo -e "${GREEN}[*] Fase 2: Enumeração Agressiva de Subdomínios${NC}"

# DNSenum
echo -e "${RED}[!] Executando dnsenum agressivo...${NC}"
dnsenum --dnsserver 8.8.8.8 --enum -f /usr/share/dnsenum/dns.txt $TARGET -o $LOG_DIR/dnsenum.txt 2>&1 &

# DNSrecon
echo -e "${YELLOW}[*] Executando dnsrecon...${NC}"
dnsrecon -d $TARGET -D /usr/share/dnsrecon/subdomains-top1mil-5000.txt -t brt -o $LOG_DIR/dnsrecon.txt 2>&1 &

# Fierce
echo -e "${YELLOW}[*] Executando fierce...${NC}"
fierce -dns $TARGET -wordlist /usr/share/dnsrecon/subdomains-top1mil-5000.txt -file $LOG_DIR/fierce.txt 2>&1 &

wait

# 3. ZONE TRANSFER
echo -e "${GREEN}[*] Fase 3: Tentativas de Zone Transfer${NC}"

# Obter nameservers
NS_SERVERS=$(dig NS $TARGET +short)

for ns in $NS_SERVERS; do
    echo -e "${RED}[!] Tentando zone transfer de $ns...${NC}"
    dig @$ns $TARGET AXFR > $LOG_DIR/zonetransfer_${ns}.txt 2>&1
    
    # Verificar se funcionou
    if grep -q "XFR" $LOG_DIR/zonetransfer_${ns}.txt || [ $(wc -l < $LOG_DIR/zonetransfer_${ns}.txt) -gt 10 ]; then
        echo -e "${GREEN}[!!!] ZONE TRANSFER BEM-SUCEDIDO DE $ns!${NC}" | tee -a $RESULTS_DIR/zone_transfer_success.txt
    fi
done

# 4. BRUTE FORCE DE SUBDOMÍNIOS
echo -e "${GREEN}[*] Fase 4: Brute Force de Subdomínios${NC}"

# Wordlist de subdomínios
if [ ! -f "/tmp/subdomains.txt" ]; then
    cat > /tmp/subdomains.txt << EOF
www
mail
ftp
admin
administrator
test
dev
staging
prod
api
app
web
www2
ns1
ns2
dns
mx
smtp
pop
imap
webmail
cpanel
whm
panel
control
manage
manager
blog
shop
store
portal
gateway
vpn
secure
ssl
secure
login
auth
sso
oauth
br
br01
haproxy01
marketing
autodiscover
webmail
EOF
fi

echo -e "${RED}[!] Brute force de subdomínios...${NC}"
for subdomain in $(cat /tmp/subdomains.txt); do
    host ${subdomain}.${TARGET} 2>&1 | grep -v "not found" | tee -a $LOG_DIR/subdomain_bruteforce.txt
done

# 5. SCANNING DE SERVIDORES DNS
echo -e "${GREEN}[*] Fase 5: Scanning de Servidores DNS${NC}"

# Nmap DNS scripts
nmap -p 53 --script dns-nsid,dns-recursion,dns-service-discovery $TARGET -oN $LOG_DIR/nmap_dns.txt

# Testar todos os nameservers
for ns in $NS_SERVERS; do
    echo -e "${YELLOW}[*] Scanning nameserver: $ns${NC}"
    nmap -p 53 --script dns-nsid,dns-recursion $ns -oN $LOG_DIR/nmap_dns_${ns}.txt 2>&1
done

# 6. TESTE DE RECURSÃO DNS
echo -e "${GREEN}[*] Fase 6: Teste de Recursão DNS${NC}"

for ns in $NS_SERVERS; do
    echo -e "${YELLOW}[*] Testando recursão em $ns...${NC}"
    dig @$ns google.com A +norecurse > $LOG_DIR/dns_recursion_${ns}.txt 2>&1
    
    if grep -q "ANSWER:" $LOG_DIR/dns_recursion_${ns}.txt && ! grep -q "flags:.*rd" $LOG_DIR/dns_recursion_${ns}.txt; then
        echo -e "${GREEN}[+] Recursão DNS habilitada em $ns${NC}" | tee -a $RESULTS_DIR/dns_recursion.txt
    fi
done

# 7. EXPLORAÇÃO DE VULNERABILIDADES BIND
echo -e "${GREEN}[*] Fase 7: Exploração de Vulnerabilidades BIND${NC}"

# Nmap BIND scripts
nmap -p 53 --script dns-zone-transfer,dns-update,dns-nsid $TARGET -oN $LOG_DIR/nmap_bind.txt

# Metasploit - BIND exploits
msfconsole -q -x "
use auxiliary/gather/dns_info;
set DOMAIN $TARGET;
run;
use auxiliary/scanner/dns/dns_amp;
set RHOSTS $TARGET;
set RPORT 53;
run;
exit;
" > $LOG_DIR/metasploit_dns.txt 2>&1

# 8. ENUMERAÇÃO DE REGISTROS DNS
echo -e "${GREEN}[*] Fase 8: Enumeração de Registros DNS${NC}"

# Tentar todos os tipos de registro
RECORD_TYPES=("A" "AAAA" "MX" "NS" "TXT" "SOA" "CNAME" "PTR" "SRV" "SPF" "DKIM" "DMARC")

for type in "${RECORD_TYPES[@]}"; do
    echo -e "${YELLOW}[*] Consultando registros $type...${NC}"
    dig $TARGET $type +noall +answer > $LOG_DIR/dig_${type}.txt 2>&1
done

# 9. SUBDOMAIN TAKEOVER
echo -e "${GREEN}[*] Fase 9: Teste de Subdomain Takeover${NC}"

# Verificar subdomínios que apontam para serviços externos
echo -e "${YELLOW}[*] Verificando subdomínios para takeover...${NC}"

# Listar todos os subdomínios encontrados
SUBDOMAINS=$(cat $LOG_DIR/subdomain_bruteforce.txt $LOG_DIR/dnsenum.txt 2>/dev/null | grep -oP '\S+\.'$TARGET | sort -u)

for subdomain in $SUBDOMAINS; do
    echo -e "${YELLOW}[*] Verificando $subdomain...${NC}"
    
    # Verificar se aponta para serviços conhecidos vulneráveis
    CNAME=$(dig $subdomain CNAME +short)
    
    if echo $CNAME | grep -q "github\|heroku\|aws\|azure\|cloudfront"; then
        echo -e "${GREEN}[+] $subdomain pode ser vulnerável a takeover: $CNAME${NC}" | tee -a $RESULTS_DIR/subdomain_takeover.txt
    fi
done

# 10. DNS CACHE POISONING
echo -e "${GREEN}[*] Fase 10: Teste de DNS Cache Poisoning${NC}"

echo -e "${YELLOW}[*] Testando vulnerabilidades de cache poisoning...${NC}"
# Nota: Isso é apenas um teste, não um ataque real
dig @8.8.8.8 $TARGET A > $LOG_DIR/dns_cache_test.txt 2>&1

# 11. PÓS-EXPLORAÇÃO
echo -e "${GREEN}[*] Fase 11: Pós-Exploração${NC}"

# Consolidar todos os subdomínios encontrados
echo -e "${GREEN}[+] Consolidando subdomínios encontrados...${NC}"
cat $LOG_DIR/subdomain_bruteforce.txt $LOG_DIR/dnsenum.txt $LOG_DIR/dnsrecon.txt $LOG_DIR/fierce.txt 2>/dev/null | \
    grep -oP '\S+\.'$TARGET | sort -u > $RESULTS_DIR/all_subdomains.txt

# Listar todos os IPs encontrados
echo -e "${GREEN}[+] Consolidando IPs encontrados...${NC}"
cat $LOG_DIR/*.txt 2>/dev/null | grep -oP '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' | sort -u > $RESULTS_DIR/all_ips.txt

# Criar mapa de infraestrutura
echo -e "${GREEN}[+] Criando mapa de infraestrutura...${NC}"
{
    echo "=== INFRAESTRUTURA DNS DE $TARGET ==="
    echo ""
    echo "=== NAMESERVERS ==="
    cat $LOG_DIR/dig_ns.txt
    echo ""
    echo "=== SUBDOMÍNIOS ==="
    cat $RESULTS_DIR/all_subdomains.txt
    echo ""
    echo "=== IPs ==="
    cat $RESULTS_DIR/all_ips.txt
} > $RESULTS_DIR/dns_infrastructure_map.txt

echo -e "${GREEN}[*] Exploração DNS concluída!${NC}"
echo -e "${GREEN}[*] Logs: $LOG_DIR${NC}"
echo -e "${GREEN}[*] Resultados: $RESULTS_DIR${NC}"

