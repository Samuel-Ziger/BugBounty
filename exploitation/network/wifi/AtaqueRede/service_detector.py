#!/usr/bin/env python3
"""
Módulo de Identificação de Serviços
Identifica serviços específicos baseado em portas e banners
"""

import socket
import logging
from typing import List, Dict, Optional
from dataclasses import dataclass
from port_scanner import OpenPort, ScanResult

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


@dataclass
class ServiceInfo:
    """Informações detalhadas sobre um serviço"""
    name: str
    version: Optional[str] = None
    protocol: str = "TCP"
    vulnerabilities: List[str] = None
    attack_type: Optional[str] = None  # Tipo de ataque recomendado


class ServiceDetector:
    """Classe para identificar serviços em portas abertas"""
    
    # Mapeamento de serviços conhecidos
    SERVICE_SIGNATURES = {
        'SSH': {
            'ports': [22],
            'banner_patterns': [r'SSH', r'OpenSSH'],
            'attack_type': 'ssh_bruteforce'
        },
        'FTP': {
            'ports': [21],
            'banner_patterns': [r'FTP', r'vsftpd', r'ProFTPD'],
            'attack_type': 'ftp_bruteforce'
        },
        'HTTP': {
            'ports': [80, 8080, 8888],
            'banner_patterns': [r'HTTP', r'Apache', r'nginx', r'IIS'],
            'attack_type': 'http_enum'
        },
        'HTTPS': {
            'ports': [443, 8443],
            'banner_patterns': [r'HTTPS', r'SSL'],
            'attack_type': 'https_enum'
        },
        'SMB': {
            'ports': [445, 139],
            'banner_patterns': [r'SMB', r'Windows'],
            'attack_type': 'smb_enum'
        },
        'RDP': {
            'ports': [3389],
            'banner_patterns': [r'RDP', r'Microsoft Terminal Services'],
            'attack_type': 'rdp_bruteforce'
        },
        'MySQL': {
            'ports': [3306],
            'banner_patterns': [r'MySQL', r'mariadb'],
            'attack_type': 'mysql_bruteforce'
        },
        'Telnet': {
            'ports': [23],
            'banner_patterns': [r'Telnet'],
            'attack_type': 'telnet_bruteforce'
        },
        'VNC': {
            'ports': [5900, 5901],
            'banner_patterns': [r'VNC', r'RFB'],
            'attack_type': 'vnc_bruteforce'
        }
    }
    
    def __init__(self):
        """Inicializa o detector de serviços"""
        pass
    
    def identify_service(self, open_port: OpenPort) -> Optional[ServiceInfo]:
        """
        Identifica o serviço em uma porta aberta
        
        Args:
            open_port: Porta aberta com informações
            
        Returns:
            ServiceInfo se identificado, None caso contrário
        """
        # Primeiro tenta identificar pelo nome do serviço já detectado
        if open_port.service:
            service_name = open_port.service
            if service_name in self.SERVICE_SIGNATURES:
                sig = self.SERVICE_SIGNATURES[service_name]
                return ServiceInfo(
                    name=service_name,
                    protocol="TCP",
                    attack_type=sig.get('attack_type')
                )
        
        # Tenta identificar pelo banner
        if open_port.banner:
            for service_name, sig in self.SERVICE_SIGNATURES.items():
                for pattern in sig['banner_patterns']:
                    import re
                    if re.search(pattern, open_port.banner, re.IGNORECASE):
                        return ServiceInfo(
                            name=service_name,
                            version=self._extract_version(open_port.banner),
                            protocol="TCP",
                            attack_type=sig.get('attack_type')
                        )
        
        # Tenta identificar pela porta
        for service_name, sig in self.SERVICE_SIGNATURES.items():
            if open_port.port in sig['ports']:
                return ServiceInfo(
                    name=service_name,
                    protocol="TCP",
                    attack_type=sig.get('attack_type')
                )
        
        # Serviço desconhecido
        return ServiceInfo(
            name=f"Unknown-{open_port.port}",
            protocol="TCP",
            attack_type='generic_scan'
        )
    
    def _extract_version(self, banner: str) -> Optional[str]:
        """
        Tenta extrair versão do banner
        
        Args:
            banner: Banner do serviço
            
        Returns:
            Versão se encontrada, None caso contrário
        """
        import re
        # Padrões comuns de versão
        patterns = [
            r'(\d+\.\d+\.\d+)',
            r'(\d+\.\d+)',
            r'v(\d+)',
            r'version[:\s]+([\d.]+)'
        ]
        
        for pattern in patterns:
            match = re.search(pattern, banner, re.IGNORECASE)
            if match:
                return match.group(1)
        
        return None
    
    def detect_services(self, scan_result: ScanResult) -> Dict[int, ServiceInfo]:
        """
        Detecta serviços em todas as portas abertas
        
        Args:
            scan_result: Resultado do escaneamento
            
        Returns:
            Dicionário mapeando porta -> ServiceInfo
        """
        services = {}
        
        logger.info(f"Identificando serviços em {scan_result.ip}...")
        
        for open_port in scan_result.open_ports:
            service_info = self.identify_service(open_port)
            if service_info:
                services[open_port.port] = service_info
                logger.info(f"  Porta {open_port.port}: {service_info.name} "
                          f"({service_info.version or 'unknown version'}) "
                          f"- Ataque: {service_info.attack_type}")
        
        return services
    
    def get_attack_priority(self, service_info: ServiceInfo) -> int:
        """
        Retorna prioridade de ataque (menor número = maior prioridade)
        
        Args:
            service_info: Informações do serviço
            
        Returns:
            Prioridade (1-10, onde 1 é maior prioridade)
        """
        priority_map = {
            'ssh_bruteforce': 2,
            'ftp_bruteforce': 3,
            'http_enum': 4,
            'https_enum': 4,
            'smb_enum': 2,
            'rdp_bruteforce': 2,
            'mysql_bruteforce': 5,
            'telnet_bruteforce': 3,
            'vnc_bruteforce': 3,
            'generic_scan': 10
        }
        
        return priority_map.get(service_info.attack_type, 10)


if __name__ == "__main__":
    # Teste
    from port_scanner import PortScanner
    
    detector = ServiceDetector()
    scanner = PortScanner()
    
    result = scanner.scan_host("127.0.0.1", [22, 80, 443])
    services = detector.detect_services(result)
    
    print("\n=== Serviços Identificados ===")
    for port, service in services.items():
        print(f"Porta {port}: {service.name} - Ataque: {service.attack_type}")


