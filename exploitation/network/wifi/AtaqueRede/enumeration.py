#!/usr/bin/env python3
"""
Módulo de Enumeração de Rede
Enumera dispositivos na rede local usando arp-scan
"""

import subprocess
import re
import logging
from typing import List, Dict, Optional
from dataclasses import dataclass

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


@dataclass
class NetworkDevice:
    """Representa um dispositivo na rede"""
    ip: str
    mac: str
    vendor: Optional[str] = None
    is_target: bool = False


class NetworkEnumerator:
    """Classe para enumerar dispositivos na rede"""
    
    def __init__(self, target_ips: List[str] = None):
        """
        Inicializa o enumerador
        
        Args:
            target_ips: Lista de IPs alvo para marcar como targets
        """
        self.target_ips = target_ips or []
        self.devices: List[NetworkDevice] = []
        
    def run_arp_scan(self) -> bool:
        """
        Executa arp-scan --localnet
        
        Returns:
            True se executado com sucesso, False caso contrário
        """
        try:
            logger.info("Iniciando enumeração de rede com arp-scan...")
            result = subprocess.run(
                ['arp-scan', '--localnet'],
                capture_output=True,
                text=True,
                timeout=60,
                check=False
            )
            
            if result.returncode != 0:
                logger.warning(f"arp-scan retornou código {result.returncode}")
                logger.debug(f"stderr: {result.stderr}")
                # Mesmo com erro, pode ter capturado alguns resultados
                if not result.stdout:
                    return False
            
            return self._parse_arp_output(result.stdout)
            
        except subprocess.TimeoutExpired:
            logger.error("arp-scan excedeu o tempo limite")
            return False
        except FileNotFoundError:
            logger.error("arp-scan não encontrado. Instale com: sudo apt-get install arp-scan")
            return False
        except Exception as e:
            logger.error(f"Erro ao executar arp-scan: {e}")
            return False
    
    def _parse_arp_output(self, output: str) -> bool:
        """
        Parseia a saída do arp-scan
        
        Args:
            output: Saída do comando arp-scan
            
        Returns:
            True se encontrou dispositivos, False caso contrário
        """
        try:
            lines = output.strip().split('\n')
            devices_found = 0
            
            # Padrão: IP\tMAC\tVendor
            pattern = re.compile(r'^(\d+\.\d+\.\d+\.\d+)\s+([0-9a-fA-F:]{17})\s+(.*)$')
            
            for line in lines:
                line = line.strip()
                if not line or line.startswith('Interface:') or line.startswith('Starting'):
                    continue
                
                match = pattern.match(line)
                if match:
                    ip = match.group(1)
                    mac = match.group(2)
                    vendor = match.group(3).strip() if match.group(3) else None
                    
                    # Verifica se é um IP alvo
                    is_target = ip in self.target_ips
                    
                    device = NetworkDevice(
                        ip=ip,
                        mac=mac,
                        vendor=vendor,
                        is_target=is_target
                    )
                    
                    self.devices.append(device)
                    devices_found += 1
                    
                    status = " [ALVO]" if is_target else ""
                    logger.info(f"Dispositivo encontrado: {ip} ({mac}){status}")
            
            if devices_found == 0:
                logger.warning("Nenhum dispositivo encontrado na rede")
                return False
            
            logger.info(f"Total de dispositivos encontrados: {devices_found}")
            return True
            
        except Exception as e:
            logger.error(f"Erro ao parsear saída do arp-scan: {e}")
            return False
    
    def get_target_devices(self) -> List[NetworkDevice]:
        """
        Retorna apenas os dispositivos alvo
        
        Returns:
            Lista de dispositivos alvo
        """
        return [d for d in self.devices if d.is_target]
    
    def get_all_devices(self) -> List[NetworkDevice]:
        """
        Retorna todos os dispositivos encontrados
        
        Returns:
            Lista de todos os dispositivos
        """
        return self.devices
    
    def get_device_by_ip(self, ip: str) -> Optional[NetworkDevice]:
        """
        Busca um dispositivo pelo IP
        
        Args:
            ip: Endereço IP do dispositivo
            
        Returns:
            NetworkDevice se encontrado, None caso contrário
        """
        for device in self.devices:
            if device.ip == ip:
                return device
        return None


def enumerate_network(target_ips: List[str]) -> List[NetworkDevice]:
    """
    Função auxiliar para enumerar a rede
    
    Args:
        target_ips: Lista de IPs alvo
        
    Returns:
        Lista de dispositivos encontrados
    """
    enumerator = NetworkEnumerator(target_ips)
    if enumerator.run_arp_scan():
        return enumerator.get_all_devices()
    return []


if __name__ == "__main__":
    # Teste
    targets = ["192.168.3.13", "192.168.3.1", "192.168.3.14"]
    enumerator = NetworkEnumerator(targets)
    if enumerator.run_arp_scan():
        print("\n=== Dispositivos Encontrados ===")
        for device in enumerator.get_all_devices():
            print(f"IP: {device.ip}, MAC: {device.mac}, Vendor: {device.vendor}")
        
        print("\n=== Alvos ===")
        for target in enumerator.get_target_devices():
            print(f"IP: {target.ip}, MAC: {target.mac}")


